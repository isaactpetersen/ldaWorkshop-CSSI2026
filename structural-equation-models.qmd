---
title: "Structural Equation Models"
---

For an overview of structural equation modeling, see my chapter on "[Structural Equation Modeling](https://isaactpetersen.github.io/Principles-Psychological-Assessment/structural-equation-modeling.html)" in the following textbook:

Petersen, I. T. (2025). *Principles of psychological assessment: With applied examples in R*. University of Iowa Libraries. <https://isaactpetersen.github.io/Principles-Psychological-Assessment>. <https://doi.org/10.25820/work.007199>

# Preamble

## Load Libraries

```{r}
library("lavaan")
library("semTools")
library("lavaanPlot")
library("lcsm")
library("tidyverse")
```

## Load Data

```{r}
mydata_long <- read.csv("./data/mydata_long.csv")
```

# Pre-Model Computation

```{r}
mydata_long$sexFactor <- factor(mydata_long$sex)

mydata_long <- mydata_long |>
  group_by(ID) |>
  mutate(
    ses_personMean = mean(ses, na.rm = TRUE),
    ses_personMeanCentered = ses - ses_personMean,
    sleep_personMean = mean(sleep, na.rm = TRUE),
    sleep_personMeanCentered = sleep - sleep_personMean,
    depression_personMean = mean(depression, na.rm = TRUE),
    depression_personMeanCentered = depression - depression_personMean,
    anxiety_personMean = mean(anxiety, na.rm = TRUE),
    anxiety_personMeanCentered = anxiety - anxiety_personMean,
  ) |>
  ungroup()

mydata_wide <- mydata_long |>
  select(-age) |>
  tidyr::pivot_wider(
    names_from  = timepoint,
    values_from = c(ses, ses_personMeanCentered, sleep, sleep_personMeanCentered, depression, depression_personMeanCentered, anxiety, anxiety_personMeanCentered)
  )
```

# Latent Growth Curve Model

## Linear Growth Curve Model

### Model Syntax

```{r}
linearGCM_syntax <- '
  # Intercept and slope
  intercept =~ 1*depression_1 + 1*depression_2 + 1*depression_3 + 1*depression_4
  slope =~ 0*depression_1 + 1*depression_2 + 2*depression_3 + 3*depression_4

  # Regression paths
  intercept ~ sexMale
  slope ~ sexMale
  
  # Time-varying covariates
  depression_1 ~ sleep_1
  depression_2 ~ sleep_2
  depression_3 ~ sleep_3
  depression_4 ~ sleep_4
  
  # Constrain observed intercepts to zero
  depression_1 ~ 0
  depression_2 ~ 0
  depression_3 ~ 0
  depression_4 ~ 0
  
  # Estimate mean of intercept and slope
  intercept ~ 1
  slope ~ 1
'
```

### Fit Model

```{r}
linearGCM_fit <- sem(
  linearGCM_syntax,
  data = mydata_wide,
  missing = "ML",
  estimator = "MLR",
  meanstructure = TRUE,
  fixed.x = FALSE)
```

### Model Summary

```{r}
summary(
  linearGCM_fit,
  fit.measures = TRUE,
  standardized = TRUE,
  rsquare = TRUE)
```

### Modification Indices

```{r}
modificationindices(
  linearGCM_fit,
  sort. = TRUE)
```

### Plots

#### Path Diagram

```{r}
#| fig-cap: "Path Diagram"

lavaanPlot::lavaanPlot(
  linearGCM_fit,
  coefs = TRUE,
  #covs = TRUE,
  stand = TRUE)
```

## Quadratic Growth Curve Model

### Model Syntax

```{r}
quadraticGCM_syntax <- '
  # Intercept and slope
  intercept =~ 1*depression_1 + 1*depression_2 + 1*depression_3 + 1*depression_4
  linear =~ 0*depression_1 + 1*depression_2 + 2*depression_3 + 3*depression_4
  quadratic =~ 0*depression_1 + 1*depression_2 + 4*depression_3 + 9*depression_4

  # Regression paths
  intercept ~ sexMale
  linear ~ sexMale
  quadratic ~ sexMale
  
  # Time-varying covariates
  depression_1 ~ sleep_1
  depression_2 ~ sleep_2
  depression_3 ~ sleep_3
  depression_4 ~ sleep_4
  
  # Constrain observed intercepts to zero
  depression_1 ~ 0
  depression_2 ~ 0
  depression_3 ~ 0
  depression_4 ~ 0
  
  # Constrain residual variances to be equal (needed to address negative variance)
  depression_1 ~~ vardep*depression_1
  depression_2 ~~ vardep*depression_2
  depression_3 ~~ vardep*depression_3
  depression_4 ~~ vardep*depression_4
  
  # Estimate mean of intercept and slope
  intercept ~ 1
  linear ~ 1
  quadratic ~ 1
'
```

### Fit Model

```{r}
quadraticGCM_fit <- sem(
  quadraticGCM_syntax,
  data = mydata_wide,
  missing = "ML",
  estimator = "MLR",
  meanstructure = TRUE,
  fixed.x = FALSE)
```

### Model Summary

```{r}
summary(
  quadraticGCM_fit,
  fit.measures = TRUE,
  standardized = TRUE,
  rsquare = TRUE)
```

### Modification Indices

```{r}
modificationindices(
  quadraticGCM_fit,
  sort. = TRUE)
```

### Plots

#### Path Diagram

```{r}
#| fig-cap: "Path Diagram"

lavaanPlot::lavaanPlot2(
  quadraticGCM_fit,
  stand = TRUE,
  coef_labels = TRUE)
```

## Latent Basis Growth Curve Model

### Model Syntax

```{r}
latentBasisGCM_syntax <- '
  # Intercept and slope
  intercept =~ 1*depression_1 + 1*depression_2 + 1*depression_3 + 1*depression_4
  slope =~ 0*depression_1 + a*depression_2 + b*depression_3 + 3*depression_4 # freely estimate the loadings for t2 and t3

  # Regression paths
  intercept ~ sexMale
  slope ~ sexMale
  
  # Time-varying covariates
  depression_1 ~ sleep_1
  depression_2 ~ sleep_2
  depression_3 ~ sleep_3
  depression_4 ~ sleep_4
  
  # Constrain observed intercepts to zero
  depression_1 ~ 0
  depression_2 ~ 0
  depression_3 ~ 0
  depression_4 ~ 0
  
  # Estimate mean of intercept and slope
  intercept ~ 1
  slope ~ 1
'
```

### Fit Model

```{r}
latentBasisGCM_fit <- sem(
  latentBasisGCM_syntax,
  data = mydata_wide,
  missing = "ML",
  estimator = "MLR",
  meanstructure = TRUE,
  fixed.x = FALSE)
```

### Model Summary

```{r}
summary(
  latentBasisGCM_fit,
  fit.measures = TRUE,
  standardized = TRUE,
  rsquare = TRUE)
```

### Modification Indices

```{r}
modificationindices(
  latentBasisGCM_fit,
  sort. = TRUE)
```

### Plots

#### Path Diagram

```{r}
#| fig-cap: "Path Diagram"

lavaanPlot::lavaanPlot(
  latentBasisGCM_fit,
  coefs = TRUE,
  #covs = TRUE,
  stand = TRUE)
```

# Compare Models

```{r}
anova(
  linearGCM_fit,
  quadraticGCM_fit
)

anova(
  linearGCM_fit,
  latentBasisGCM_fit
)

anova(
  latentBasisGCM_fit,
  quadraticGCM_fit
)
```

# Latent Change Score Model

## Model Syntax

```{r}
bivariateLCSM_syntax <- lcsm::specify_bi_lcsm(
  timepoints = 4,
  var_x = "depression_",
  model_x = list(
    alpha_constant = TRUE, # alpha = intercept (constant change factor)
    beta = TRUE, # beta = proportional change factor (latent true score predicting its change score)
    phi = TRUE), # phi = autoregression of change scores
  var_y = "anxiety_",
  model_y = list(
    alpha_constant = TRUE, # alpha = intercept (constant change factor)
    beta = TRUE, # beta = proportional change factor (latent true score predicting its change score)
    phi = TRUE), # phi = autoregression of change scores
  coupling = list(
    delta_lag_xy = TRUE,
    delta_lag_yx = TRUE),
  change_letter_x = "g",
  change_letter_y = "j")

cat(bivariateLCSM_syntax)
```

## Fit Model

```{r}
bivariateLCSM_fit <- lcsm::fit_bi_lcsm(
  data = mydata_wide,
  var_x = c("depression_1","depression_2","depression_3","depression_4"),
  var_y = c("anxiety_1","anxiety_2","anxiety_3","anxiety_4"),
  model_x = list(
    alpha_constant = TRUE, # alpha = intercept (constant change factor)
    beta = TRUE, # beta = proportional change factor (latent true score predicting its change score)
    phi = TRUE), # phi = autoregression of change scores
  model_y = list(
    alpha_constant = TRUE, # alpha = intercept (constant change factor)
    beta = TRUE, # beta = proportional change factor (latent true score predicting its change score)
    phi = TRUE), # phi = autoregression of change scores
  coupling = list(
    delta_lag_xy = TRUE,
    xi_lag_yx = TRUE),
  fixed.x = FALSE
  )
```

## Model Summary

```{r}
summary(
  bivariateLCSM_fit,
  fit.measures = TRUE,
  standardized = TRUE,
  rsquare = TRUE)

lcsm::extract_param(bivariateLCSM_fit)
```

## Modification Indices

```{r}
modificationindices(
  bivariateLCSM_fit,
  sort. = TRUE)
```

## Plots

### Path Diagram

```{r}
#| fig-cap: "Path Diagram"

lavaanPlot::lavaanPlot2(
  bivariateLCSM_fit,
  stand = TRUE,
  coef_labels = TRUE)
```

```{r}
#| fig-cap: "Path Diagram"

lcsm::plot_lcsm(
  lavaan_object = bivariateLCSM_fit,
  lcsm = "bivariate",
  lavaan_syntax = bivariateLCSM_syntax,
  edge.label.cex = .9,
  lcsm_colours = TRUE)
```

To plot model-implied trajectories, see this resource:

<https://thechangelab.stanford.edu/tutorials/growth-modeling/latent-change-score-modeling-lavaan/> (archived at <https://perma.cc/A2KZ-QPD9>)

# Cross-Lagged Panel Model

## Model Syntax

```{r}
clpm_syntax <- '
  # Autoregressive Paths
  depression_4 ~ depression_3
  depression_3 ~ depression_2
  depression_2 ~ depression_1
  
  anxiety_4 ~ anxiety_3
  anxiety_3 ~ anxiety_2
  anxiety_2 ~ anxiety_1
  
  # Concurrent Covariances
  depression_1 ~~ anxiety_1
  depression_2 ~~ anxiety_2
  depression_3 ~~ anxiety_3
  depression_4 ~~ anxiety_4
  
  # Cross-Lagged Paths
  depression_4 ~ anxiety_3
  depression_3 ~ anxiety_2
  depression_2 ~ anxiety_1
  
  anxiety_4 ~ depression_3
  anxiety_3 ~ depression_2
  anxiety_2 ~ depression_1
'
```

## Fit Model

```{r}
clpm_fit <- sem(
  clpm_syntax,
  data = mydata_wide,
  missing = "ML",
  estimator = "MLR",
  meanstructure = TRUE,
  fixed.x = FALSE)
```

## Model Summary

```{r}
summary(
  clpm_fit,
  fit.measures = TRUE,
  standardized = TRUE,
  rsquare = TRUE)
```

## Modification Indices

```{r}
modificationindices(
  clpm_fit,
  sort. = TRUE)
```

## Plots

### Path Diagram

```{r}
#| fig-cap: "Path Diagram"

lavaanPlot::lavaanPlot(
  clpm_fit,
  coefs = TRUE,
  #covs = TRUE,
  stand = TRUE)
```

# Random-Intercepts Cross-Lagged Panel Model

Adapted from:

- Mulder & Hamaker (2021): <https://doi.org/10.1080/10705511.2020.1784738>
  - <https://jeroendmulder.github.io/RI-CLPM/lavaan.html> (archived at <https://perma.cc/2K6A-WUJQ>)
- Mund & Nestler (2017): <https://osf.io/a4dhk>

## Model Syntax

```{r}
riclpm_syntax <- '
  # Random Intercepts
  depression =~ 1*depression_1 + 1*depression_2 + 1*depression_3 + 1*depression_4
  anxiety =~ 1*anxiety_1 + 1*anxiety_2 + 1*anxiety_3 + 1*anxiety_4
  
  # Create Within-Person Centered Variables
  wdep1 =~ 1*depression_1
  wdep2 =~ 1*depression_2
  wdep3 =~ 1*depression_3
  wdep4 =~ 1*depression_4
  
  wanx1 =~ 1*anxiety_1
  wanx2 =~ 1*anxiety_2
  wanx3 =~ 1*anxiety_3
  wanx4 =~ 1*anxiety_4
  
  # Autoregressive Paths
  wdep4 ~ wdep3
  wdep3 ~ wdep2
  wdep2 ~ wdep1
  
  wanx4 ~ wanx3
  wanx3 ~ wanx2
  wanx2 ~ wanx1
  
  # Concurrent Covariances
  wdep1 ~~ wanx1
  wdep2 ~~ wanx2
  wdep3 ~~ wanx3
  wdep4 ~~ wanx4
  
  # Cross-Lagged Paths
  wdep4 ~ wanx3
  wdep3 ~ wanx2
  wdep2 ~ wanx1
  
  wanx4 ~ wdep3
  wanx3 ~ wdep2
  wanx2 ~ wdep1
  
  # Variance and Covariance of Random Intercepts
  depression ~~ depression
  anxiety ~~ anxiety
  depression ~~ anxiety
  
  # Variances of Within-Person Centered Variables
  wdep1 ~~ wdep1
  wdep2 ~~ wdep2
  wdep3 ~~ wdep3
  wdep4 ~~ wdep4
  
  wanx1 ~~ wanx1
  wanx2 ~~ wanx2
  wanx3 ~~ wanx3
  wanx4 ~~ wanx4
  
  # Fix Error Variances of Observed Variables to Zero
  depression_1 ~~ 0*depression_1
  depression_2 ~~ 0*depression_2
  depression_3 ~~ 0*depression_3
  depression_4 ~~ 0*depression_4
  
  anxiety_1 ~~ 0*anxiety_1
  anxiety_2 ~~ 0*anxiety_2
  anxiety_3 ~~ 0*anxiety_3
  anxiety_4 ~~ 0*anxiety_4
  
  # Fix the Covariances Between the Random Intercepts and the Latents at T1 to Zero
  wdep1 ~~ 0*depression
  wdep1 ~~ 0*anxiety
  
  wanx1 ~~ 0*depression
  wanx1 ~~ 0*anxiety
  
  # Estimate Observed Intercepts
  depression_1 ~ 1
  depression_2 ~ 1
  depression_3 ~ 1
  depression_4 ~ 1
  
  anxiety_1 ~ 1
  anxiety_2 ~ 1
  anxiety_3 ~ 1
  anxiety_4 ~ 1
  
  # Fix the Means of the Latents to Zero
  wdep1 ~ 0*1
  wdep2 ~ 0*1
  wdep3 ~ 0*1
  wdep4 ~ 0*1
  
  wanx1 ~ 0*1
  wanx2 ~ 0*1
  wanx3 ~ 0*1
  wanx4 ~ 0*1
  
  depression ~ 0*1
  anxiety ~ 0*1
'
```

## Fit Model

```{r}
riclpm_fit <- sem(
  riclpm_syntax,
  data = mydata_wide,
  missing = "ML",
  estimator = "MLR",
  fixed.x = FALSE,
  bounds = "standard"
)
```

Modify the syntax to address the model fit errors.

## Model Summary

```{r}
#| eval: false

summary(
  withinPersonCLPM_fit,
  fit.measures = TRUE,
  standardized = TRUE,
  rsquare = TRUE)
```

## Modification Indices

```{r}
#| eval: false

modificationindices(
  riclpm_fit,
  sort. = TRUE)
```

## Path Diagram

```{r}
#| eval: false

lavaanPlot::lavaanPlot(
  riclpm_fit,
  coefs = TRUE,
  #covs = TRUE,
  stand = TRUE)
```

# Multilevel SEM

## Model Syntax

```{r}
multilevelSEM_syntax <- '
    level: 1
        depression ~ sleep_personMeanCentered + anxiety_personMeanCentered + ses_personMeanCentered
    level: 2
        depression ~ sleep_personMean + anxiety_personMean + ses_personMean + sexMale
'
```

## Fit Model

```{r}
multilevelSEM_fit <- sem(
  multilevelSEM_syntax,
  data = mydata_long,
  cluster = "ID",
  #missing = "ML", # commenting out due to error
  estimator = "MLR",
  fixed.x = FALSE)
```

## Model Summary

```{r}
summary(
  multilevelSEM_fit,
  fit.measures = TRUE,
  standardized = TRUE,
  rsquare = TRUE)
```

## Modification Indices

```{r}
modificationindices(
  multilevelSEM_fit,
  sort. = TRUE)
```

## Path Diagram

```{r}
lavaanPlot::lavaanPlot(
  multilevelSEM_fit,
  coefs = TRUE,
  #covs = TRUE,
  stand = TRUE)
```

# Longitudinal Measurement Invariance
